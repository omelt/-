M.define("/js/note/GinfoDraftDialog",function(d,c,f){d("jq-tmpl");var b=d("dialog/Dialog"),a=d("dialog/confirm"),g=d("ScrollBar"),e=d("dialog/alert");var h={inited:false,init:function(){this.dialog=new b({content:$("#_j_full_draftbox_dialog_tmpl").tmpl({}),width:460});this.draftListCnt=this.dialog.getPanel().find("._j_draft_list");this.draftNumDom=this.dialog.getPanel().find("._j_draftnum");this.bindEvents();this.inited=true},show:function(){if(!this.inited){this.init()}this.getData($.proxy(function(){this.dialog.show()},this))},getData:function(i){$.get("/note/ajax.php",{act:"getDraftList"},$.proxy(function(j){if(j.data&&j.data.html){this.draftListCnt.html(j.data.html);this.draftNumDom.text(this.draftListCnt.children().length);typeof i=="function"&&i()}},this),"json")},bindEvents:function(){M.Event(this.dialog).on("aftershow",$.proxy(function(){if(!this.scrollBar){this.scrollBar=new g({wrap:this.draftListCnt.parent(),container:this.draftListCnt,barTPL:'<div style="position:absolute; top:0; right:0; padding:1px"><div style="width:5px; height:100%; background:#ccc;border-radius: 10px;"></div></div>'})}M.Event(this.scrollBar).fire("contentchange")},this));this.dialog.getPanel().on("click","._j_draft_confirm",$.proxy(function(){this.dialog.close()},this)).on("click","._j_del_draft",$.proxy(function(i){a.pop("确认删除该草稿吗？",$.proxy(function(){var m=$(i.currentTarget),k=m.data("rid");var j=m.closest("._j_draft_container");$.post("/ajax/ajax_rough.php",{action:"delete_rough",id:k});var l=$("._j_draft_container").find("._j_draft_num b");l.text((+l.text())-1);m.closest("li").remove();if(j.find("._j_draft_list li").length<10){j.find("._j_draft_full").remove()}if(j.find("._j_draft_list li").length===0){j.find("._j_draft_body").remove();j.find(".draft_tips").removeClass("hide")}this.draftNumDom.text(this.draftListCnt.children().length);M.Event(this.scrollBar).fire("contentchange")},this))},this)).on("click","._j_draft_clear",$.proxy(function(j){var k=$(j.currentTarget);var i=k.closest("._j_draft_container");if(i.find("._j_draft_list li").length===0){e.pop("草稿箱已经干干净净啦~")}else{a.pop("确认清空所有草稿吗？",$.proxy(function(){$.post("/ajax/ajax_rough.php",{action:"delete_all_rough"});i.find("._j_draft_body").remove();i.find("._j_draft_full").remove();var l=i.find("._j_draft_num b");l.text(0);i.find(".draft_tips").removeClass("hide");this.draftNumDom.text(0);M.Event(this.scrollBar).fire("contentchange")},this))}},this))}};f.exports=h});M.define("/js/note/ControllerEditSidebar",function(c){c("/js/jquery.jplayer.js");var j=c("/js/note/PicUploadPop"),l=c("/js/note/PicUpByQRCode"),a=c("/js/module/uploader/Pluploader"),g=c("/js/EmojiBox"),m=c("/js/note/VideoUploadPop2"),n=c("/js/note/ParagraphInsertPop"),d=c("StickyAndStayBlock"),f=c("/js/note/GinfoDraftDialog"),k=c("TopTip"),b=c("ClickToggle"),i=c("dialog/confirm"),e=c("dialog/alert");var h={url:"/note/up/uploadMusic",runtimes:"html5,html4",multi_selection:false,filters:[{title:"MP3 files",extensions:"mp3"}]};return{events:{"click,._j_insert_choice":"onInsertChoiceClick","click,._j_btn_save":"onSaveDraftClick"},init:function(){this.musicBox=$("#_j_add_music_box");this.musicUploadBtn=$("#_j_upload_music");this.initCloseEvent();this.bindEvents();this.initMusicPlay()},onInsertChoiceClick:function(p){var q=$(p.currentTarget).closest("._j_sidebar_item").children("._j_insert_panel");this.container.find("._j_insert_panel").not(".hide").addClass("hide").trigger("hide");var o=this;if(!q.hasClass("add-panel-music")){M.Event.fire("detect can use sidebar",{callback:function(){o.initInsertPop(q)}})}else{this.initInsertPop(q)}},initInsertPop:function(o){o.removeClass("hide");if(!o.data("inited")){o.data("inited",true);if(o.hasClass("add-panel-photo")){this.initPicUploadPop(o)}else{if(o.hasClass("add-panel-emotion")){this.initEmojiPop(o)}else{if(o.hasClass("add-panel-video")){this.initVideoUploadPop(o)}else{if(o.hasClass("add-panel-title")){this.initParagraphInsertPop(o)}else{if(o.hasClass("add-panel-music")){this.initMusicInsertPop(o)}}}}}}o.trigger("show")},onSaveDraftClick:function(o){M.Event.fire("detect content valid",{handlerName:"保存草稿",fireFunc:"can save draft",})},initStickyStatus:function(){var o=this.stickyBlock=new d({elem:this.container.children("._j_sidebar_sticky_cnt"),offsetTop:20,stayToElement:this.container.parent()});M.Event(o).on("element height change",function(p){M.Event.fire("sticky element height change",p)});M.Event.on("content chunk loaded",M.bind(function(){M.Event(o).fire("stay element height change",{height:this.container.parent().height()})},this))},bindEvents:function(){M.Event.on("qiniu video upload failed",M.bind(function(p){mfwPageEvent("ginfo","qiniu_upload_failed",{id:window.Env.id,error_info:(p.isTopvideo?"来自头图视频; ":"")+this.getErrorInfo(p),});var q=p.errTip,o=p.errInfo.status;if(o==400||o==401||o==579){q="上传失败，请保存后刷新再试或提交反馈！"}e.pop(q)},this));M.Event.on("can save draft",M.bind(function(){var o=this.container.find("._j_btn_save");if(!o.data("locking")){o.data("locking",true);M.Event.fire("detect has saved draft",{callback:$.proxy(function(){o.data("locking",false);k.show("保存草稿成功");o.parent().children("._j_draft_save_time").text(this.getFormatTime()+" 保存了草稿");window.Env.isDraftSaved=1},this)})}},this));M.Event.on("paragrah edit triggered",M.bind(function(o){var p=this.container.find("._j_insert_panel").filter(".add-panel-title");this.initParagraphInsertPop(p);this.paragraphPop.setEditInfo(o);p.removeClass("hide").siblings().addClass("hide")},this));M.Event.on("note content changed",M.bind(function(){this.container.find("._j_draft_save_time").text(this.getFormatTime()+" 自动保存了草稿")},this));M.Event.on("after top height changed",M.bind(function(){this.stickyBlock?M.Event.fire("content chunk loaded"):this.initStickyStatus()},this))},getErrorInfo:function(o){var p=o.errInfo,q=p.status?"code: "+p.status+"; ":"";if(p.detail){q+="信息: "+p.detail}if(p.text){q+=" 补充: "+p.text}if(!q){q="未知错误"}return q},getFormatTime:function(){var o=new Date();return this.fillTimeDigit(o.getHours())+":"+this.fillTimeDigit(o.getMinutes())+":"+this.fillTimeDigit(o.getSeconds())},fillTimeDigit:function(o){o+="";o.length<2&&(o="0"+o);return o},initCloseEvent:function(){var o=new b({container:".sidebar-item",innerSelector:"._j_insert_choice,._j_insert_panel",outHandler:M.bind(function(q,p){if((this.videoUploadPop&&this.videoUploadPop.isUploading())||(this.picUploadPop&&this.picUploadPop.isUploading())||(this.paragraphPop&&this.paragraphPop.isUploading())){return false}var r=$(p.target);if(!r.hasClass("popbtn")&&!r.hasClass("_j_paragraph_title_edit")&&!r.closest(".layer_content").length){this.container.find("._j_insert_panel").not(".hide").addClass("hide").trigger("hide")}},this)})},initPicUploadPop:function(o){if(!this.picUpByQRCode){this.picUpByQRCode=new l({container:o})}if(!this.picUploadPop){this.picUploadPop=new j({container:o,noteId:window.Env.id})}},initEmojiPop:function(o){if(!this.emojiPop){this.emojiPop=new g({container:o});M.Event(this.emojiPop).on("emoji selected",function(p){var q=p.emoji.title;M.Event.fire("new content added",{text:"("+q+")"})})}},initVideoUploadPop:function(o){if(!this.videoUploadPop){this.videoUploadPop=new m({container:o,uploadBtn:"._j_upload_video_trigger",noteId:this.data.id})}},initParagraphInsertPop:function(o){if(!this.paragraphPop){this.paragraphPop=new n({container:o})}},initMusicInsertPop:function(p){var o=this.musicBox;o.on("click","._j_edit_trigger",function(){o.removeClass("_j_uploaded_mode _j_beforeupload_mode").addClass("_j_editing_mode").find("._j_music_name_input").select().focus()}).on("click","._j_rem_trigger",$.proxy(function(){i.pop("确认删除音乐？",$.proxy(function(){o.removeClass("_j_uploaded_mode").addClass("_j_beforeupload_mode").siblings("._j_insert_choice").show().siblings("._j_modify_choice").hide();M.Event.fire("note save info",{key:{sMusic:"",sMusicName:""}});$.post("/note/music/delete",{mid:o.data("id")},function(q){if(q&&(0==q.code)){o.data("id","")}},"json");this.pauseMusic()},this))},this)).on("click","._j_save_name_btn",$.proxy(function(){var q=$.trim(o.find("._j_music_name_input").val());if(!q){e.pop("音乐名不能为空")}else{o.addClass("_j_uploaded_mode").removeClass("_j_editing_mode").data("name",q).find("._j_music_name").text("已上传 - "+q).end().siblings("._j_modify_choice").find("._j_m_name").text(q);M.Event.fire("note save info",{key:{sMusicName:q}});$.post("/note/music/rename",{mid:o.data("id"),music_name:q},function(r){if(r&&(1==r.code)&&r.msg){e.pop(r.msg)}},"json")}},this)).on("click","._j_cancel_name_btn",function(){o.addClass("_j_uploaded_mode").removeClass("_j_editing_mode").find("._j_music_name_input").val(o.data("name"))});return new a(this.musicUploadBtn,h,this.musicUploaderHandlers,this)},musicUploaderHandlers:{FilesAdded:function(o,p){o.start();this.musicPlayDom&&this.pauseMusic()},BeforeUpload:function(o,p){this.musicUploadBtn.addClass("btn-loading")},FileUploaded:function(o,q,p){this.musicUploadBtn.removeClass("btn-loading");var r=$.parseJSON(p.response);if(r.url){var s=q.name.split(".");s.pop();s=s.join(".");this.musicBox.removeClass("_j_beforeupload_mode").addClass("_j_uploaded_mode").find("._j_music_name").text("已上传 - "+s).end().find("._j_music_name_input").val(s).end().data({file:r.id,name:s});this.musicBox.siblings("._j_insert_choice").hide().siblings("._j_modify_choice").show().find("._j_m_name").text(s);M.Event.fire("note save info",{key:{sMusic:r.id,sMusicName:s}});musicBox=this.musicBox;$.post("/note/music/add",{music:r.id,music_name:s,new_iid:window.Env.id},function(t){if(t&&(0==t.code)&&t.data){musicBox.data("id",t.data)}},"json");this.musicPlayDom?this.reSetMusic(r.url):this.initMusicPlay(r.url)}else{e.pop("上传失败，请稍后再试！")}},Error:function(o,p){M.error(arguments)}},reSetMusic:function(o){this.musicPlayDom.jPlayer("setMedia",{mp3:o});this.startPlay()},initMusicPlay:function(o){var p=$("._j_music_switch");var q=this;if(!p.closest("._j_modify_choice").is(":visible")){return false}this.musicControl=p.find("._j_music_visible");this.musicPlayDom=p.find(".hd_audio");o=o||this.musicPlayDom.data("music");this.musicPlayDom.jPlayer({preload:"auto",ready:function(){$(this).jPlayer("setMedia",{mp3:o});$(this).jPlayer("play");q.musicControl.addClass("play").removeClass("pause")},ended:function(){$(this).jPlayer("setMedia",{mp3:o}).jPlayer("play");q.musicControl.addClass("play").removeClass("pause")},swfPath:"/swf",supplied:"mp3",wmode:"window"});this.musicControl.on("click",$.proxy(function(){var r=this.musicPlayDom.data("jPlayer");if(r.status.paused||r.status.ended||r.status.waitForPlay){this.playMusic();this.isMusciOpen=true}else{this.pauseMusic();this.isMusciOpen=false}},this));this.startPlay()},startPlay:function(){!this.musicControl.hasClass("play")&&this.musicControl.trigger("click")},pauseMusic:function(){this.musicPlayDom.jPlayer("pause");this.musicControl.addClass("pause").removeClass("play")},playMusic:function(){this.musicPlayDom.jPlayer("play");this.musicControl.addClass("begin_play").removeClass("pause");setTimeout($.proxy(function(){this.musicControl.addClass("play").removeClass("begin_play")},this),500)}}});
/*!
 * jQuery UI Sortable 1.11.3
 * http://jqueryui.com
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/sortable/
 */
M.define("jqui-sortable",function(a){var b=$.widget("ui.sortable",$.ui.mouse,{version:"1.11.3",widgetEventPrefix:"sort",ready:false,options:{appendTo:"parent",axis:false,connectWith:false,containment:false,cursor:"auto",cursorAt:false,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1000,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(d,c,e){return(d>=c)&&(d<(c+e))},_isFloating:function(c){return(/left|right/).test(c.css("float"))||(/inline|table-cell/).test(c.css("display"))},_create:function(){var c=this.options;this.containerCache={};this.element.addClass("ui-sortable");this.refresh();this.floating=this.items.length?c.axis==="x"||this._isFloating(this.items[0].item):false;this.offset=this.element.offset();this._mouseInit();this._setHandleClassName();this.ready=true},_setOption:function(c,d){this._super(c,d);if(c==="handle"){this._setHandleClassName()}},_setHandleClassName:function(){this.element.find(".ui-sortable-handle").removeClass("ui-sortable-handle");$.each(this.items,function(){(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item).addClass("ui-sortable-handle")})},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").find(".ui-sortable-handle").removeClass("ui-sortable-handle");this._mouseDestroy();for(var c=this.items.length-1;c>=0;c--){this.items[c].item.removeData(this.widgetName+"-item")}return this},_mouseCapture:function(e,f){var c=null,g=false,d=this;if(this.reverting){return false}if(this.options.disabled||this.options.type==="static"){return false}this._refreshItems(e);$(e.target).parents().each(function(){if($.data(this,d.widgetName+"-item")===d){c=$(this);return false}});if($.data(e.target,d.widgetName+"-item")===d){c=$(e.target)}if(!c){return false}if(this.options.handle&&!f){$(this.options.handle,c).find("*").addBack().each(function(){if(this===e.target){g=true}});if(!g){return false}}this.currentItem=c;this._removeCurrentsFromItems();return true},_mouseStart:function(f,g,d){var e,c,h=this.options;this.currentContainer=this;this.refreshPositions();this.helper=this._createHelper(f);this._cacheHelperProportions();this._cacheMargins();this.scrollParent=this.helper.scrollParent();this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};$.extend(this.offset,{click:{left:f.pageX-this.offset.left,top:f.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.helper.css("position","absolute");this.cssPosition=this.helper.css("position");this.originalPosition=this._generatePosition(f);this.originalPageX=f.pageX;this.originalPageY=f.pageY;(h.cursorAt&&this._adjustOffsetFromHelper(h.cursorAt));this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]};if(this.helper[0]!==this.currentItem[0]){this.currentItem.hide()}this._createPlaceholder();if(h.containment){this._setContainment()}if(h.cursor&&h.cursor!=="auto"){c=this.document.find("body");this.storedCursor=c.css("cursor");c.css("cursor",h.cursor);this.storedStylesheet=$("<style>*{ cursor: "+h.cursor+" !important; }</style>").appendTo(c)}if(h.opacity){if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity")}this.helper.css("opacity",h.opacity)}if(h.zIndex){if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex")}this.helper.css("zIndex",h.zIndex)}if(this.scrollParent[0]!==this.document[0]&&this.scrollParent[0].tagName!=="HTML"){this.overflowOffset=this.scrollParent.offset()}this._trigger("start",f,this._uiHash());if(!this._preserveHelperProportions){this._cacheHelperProportions()}if(!d){for(e=this.containers.length-1;e>=0;e--){this.containers[e]._trigger("activate",f,this._uiHash(this))}}if($.ui.ddmanager){$.ui.ddmanager.current=this}if($.ui.ddmanager&&!h.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,f)}this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(f);return true},_mouseDrag:function(g){var e,f,d,j,h=this.options,c=false;this.position=this._generatePosition(g);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==this.document[0]&&this.scrollParent[0].tagName!=="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-g.pageY<h.scrollSensitivity){this.scrollParent[0].scrollTop=c=this.scrollParent[0].scrollTop+h.scrollSpeed}else{if(g.pageY-this.overflowOffset.top<h.scrollSensitivity){this.scrollParent[0].scrollTop=c=this.scrollParent[0].scrollTop-h.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-g.pageX<h.scrollSensitivity){this.scrollParent[0].scrollLeft=c=this.scrollParent[0].scrollLeft+h.scrollSpeed}else{if(g.pageX-this.overflowOffset.left<h.scrollSensitivity){this.scrollParent[0].scrollLeft=c=this.scrollParent[0].scrollLeft-h.scrollSpeed}}}else{if(g.pageY-this.document.scrollTop()<h.scrollSensitivity){c=this.document.scrollTop(this.document.scrollTop()-h.scrollSpeed)}else{if(this.window.height()-(g.pageY-this.document.scrollTop())<h.scrollSensitivity){c=this.document.scrollTop(this.document.scrollTop()+h.scrollSpeed)}}if(g.pageX-this.document.scrollLeft()<h.scrollSensitivity){c=this.document.scrollLeft(this.document.scrollLeft()-h.scrollSpeed)}else{if(this.window.width()-(g.pageX-this.document.scrollLeft())<h.scrollSensitivity){c=this.document.scrollLeft(this.document.scrollLeft()+h.scrollSpeed)}}}if(c!==false&&$.ui.ddmanager&&!h.dropBehaviour){$.ui.ddmanager.prepareOffsets(this,g)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}for(e=this.items.length-1;e>=0;e--){f=this.items[e];d=f.item[0];j=this._intersectsWithPointer(f);if(!j){continue}if(f.instance!==this.currentContainer){continue}if(d!==this.currentItem[0]&&this.placeholder[j===1?"next":"prev"]()[0]!==d&&!$.contains(this.placeholder[0],d)&&(this.options.type==="semi-dynamic"?!$.contains(this.element[0],d):true)){this.direction=j===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(f)){this._rearrange(g,f)}else{break}this._trigger("change",g,this._uiHash());break}}this._contactContainers(g);if($.ui.ddmanager){$.ui.ddmanager.drag(this,g)}this._trigger("sort",g,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(e,g){if(!e){return}if($.ui.ddmanager&&!this.options.dropBehaviour){$.ui.ddmanager.drop(this,e)}if(this.options.revert){var d=this,h=this.placeholder.offset(),c=this.options.axis,f={};if(!c||c==="x"){f.left=h.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)}if(!c||c==="y"){f.top=h.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)}this.reverting=true;$(this.helper).animate(f,parseInt(this.options.revert,10)||500,function(){d._clear(e)})}else{this._clear(e,g)}return false},cancel:function(){if(this.dragging){this._mouseUp({target:null});if(this.options.helper==="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}for(var c=this.containers.length-1;c>=0;c--){this.containers[c]._trigger("deactivate",null,this._uiHash(this));if(this.containers[c].containerCache.over){this.containers[c]._trigger("out",null,this._uiHash(this));this.containers[c].containerCache.over=0}}}if(this.placeholder){if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0])}if(this.options.helper!=="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove()}$.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){$(this.domPosition.prev).after(this.currentItem)}else{$(this.domPosition.parent).prepend(this.currentItem)}}return this},serialize:function(e){var c=this._getItemsAsjQuery(e&&e.connected),d=[];e=e||{};$(c).each(function(){var f=($(e.item||this).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[\-=_](.+)/));if(f){d.push((e.key||f[1]+"[]")+"="+(e.key&&e.expression?f[1]:f[2]))}});if(!d.length&&e.key){d.push(e.key+"=")}return d.join("&")},toArray:function(e){var c=this._getItemsAsjQuery(e&&e.connected),d=[];e=e||{};c.each(function(){d.push($(e.item||this).attr(e.attribute||"id")||"")});return d},_intersectsWith:function(o){var e=this.positionAbs.left,d=e+this.helperProportions.width,m=this.positionAbs.top,k=m+this.helperProportions.height,f=o.left,c=f+o.width,p=o.top,j=p+o.height,q=this.offset.click.top,i=this.offset.click.left,h=(this.options.axis==="x")||((m+q)>p&&(m+q)<j),n=(this.options.axis==="y")||((e+i)>f&&(e+i)<c),g=h&&n;if(this.options.tolerance==="pointer"||this.options.forcePointerForContainers||(this.options.tolerance!=="pointer"&&this.helperProportions[this.floating?"width":"height"]>o[this.floating?"width":"height"])){return g}else{return(f<e+(this.helperProportions.width/2)&&d-(this.helperProportions.width/2)<c&&p<m+(this.helperProportions.height/2)&&k-(this.helperProportions.height/2)<j)}},_intersectsWithPointer:function(e){var f=(this.options.axis==="x")||this._isOverAxis(this.positionAbs.top+this.offset.click.top,e.top,e.height),d=(this.options.axis==="y")||this._isOverAxis(this.positionAbs.left+this.offset.click.left,e.left,e.width),h=f&&d,c=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();if(!h){return false}return this.floating?(((g&&g==="right")||c==="down")?2:1):(c&&(c==="down"?2:1))},_intersectsWithSides:function(f){var d=this._isOverAxis(this.positionAbs.top+this.offset.click.top,f.top+(f.height/2),f.height),e=this._isOverAxis(this.positionAbs.left+this.offset.click.left,f.left+(f.width/2),f.width),c=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();if(this.floating&&g){return((g==="right"&&e)||(g==="left"&&!e))}else{return c&&((c==="down"&&d)||(c==="up"&&!d))}},_getDragVerticalDirection:function(){var c=this.positionAbs.top-this.lastPositionAbs.top;return c!==0&&(c>0?"down":"up")},_getDragHorizontalDirection:function(){var c=this.positionAbs.left-this.lastPositionAbs.left;return c!==0&&(c>0?"right":"left")},refresh:function(c){this._refreshItems(c);this._setHandleClassName();this.refreshPositions();return this},_connectWith:function(){var c=this.options;return c.connectWith.constructor===String?[c.connectWith]:c.connectWith},_getItemsAsjQuery:function(c){var e,d,l,g,h=[],f=[],k=this._connectWith();if(k&&c){for(e=k.length-1;e>=0;e--){l=$(k[e],this.document[0]);for(d=l.length-1;d>=0;d--){g=$.data(l[d],this.widgetFullName);if(g&&g!==this&&!g.options.disabled){f.push([$.isFunction(g.options.items)?g.options.items.call(g.element):$(g.options.items,g.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),g])}}}}f.push([$.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):$(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);function m(){h.push(this)}for(e=f.length-1;e>=0;e--){f[e][0].each(m)}return $(h)},_removeCurrentsFromItems:function(){var c=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=$.grep(this.items,function(e){for(var d=0;d<c.length;d++){if(c[d]===e.item[0]){return false}}return true})},_refreshItems:function(c){this.items=[];this.containers=[this];var g,e,n,h,m,d,p,o,k=this.items,f=[[$.isFunction(this.options.items)?this.options.items.call(this.element[0],c,{item:this.currentItem}):$(this.options.items,this.element),this]],l=this._connectWith();if(l&&this.ready){for(g=l.length-1;g>=0;g--){n=$(l[g],this.document[0]);for(e=n.length-1;e>=0;e--){h=$.data(n[e],this.widgetFullName);if(h&&h!==this&&!h.options.disabled){f.push([$.isFunction(h.options.items)?h.options.items.call(h.element[0],c,{item:this.currentItem}):$(h.options.items,h.element),h]);this.containers.push(h)}}}}for(g=f.length-1;g>=0;g--){m=f[g][1];d=f[g][0];for(e=0,o=d.length;e<o;e++){p=$(d[e]);p.data(this.widgetName+"-item",m);k.push({item:p,instance:m,width:0,height:0,left:0,top:0})}}},refreshPositions:function(c){if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset()}var e,f,d,g;for(e=this.items.length-1;e>=0;e--){f=this.items[e];if(f.instance!==this.currentContainer&&this.currentContainer&&f.item[0]!==this.currentItem[0]){continue}d=this.options.toleranceElement?$(this.options.toleranceElement,f.item):f.item;if(!c){f.width=d.outerWidth();f.height=d.outerHeight()}g=d.offset();f.left=g.left;f.top=g.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)}else{for(e=this.containers.length-1;e>=0;e--){g=this.containers[e].element.offset();this.containers[e].containerCache.left=g.left;this.containers[e].containerCache.top=g.top;this.containers[e].containerCache.width=this.containers[e].element.outerWidth();this.containers[e].containerCache.height=this.containers[e].element.outerHeight()}}return this},_createPlaceholder:function(d){d=d||this;var c,e=d.options;if(!e.placeholder||e.placeholder.constructor===String){c=e.placeholder;e.placeholder={element:function(){var g=d.currentItem[0].nodeName.toLowerCase(),f=$("<"+g+">",d.document[0]).addClass(c||d.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");if(g==="tr"){d.currentItem.children().each(function(){$("<td>&#160;</td>",d.document[0]).attr("colspan",$(this).attr("colspan")||1).appendTo(f)})}else{if(g==="img"){f.attr("src",d.currentItem.attr("src"))}}if(!c){f.css("visibility","hidden")}return f},update:function(f,g){if(c&&!e.forcePlaceholderSize){return}if(!g.height()){g.height(d.currentItem.innerHeight()-parseInt(d.currentItem.css("paddingTop")||0,10)-parseInt(d.currentItem.css("paddingBottom")||0,10))}if(!g.width()){g.width(d.currentItem.innerWidth()-parseInt(d.currentItem.css("paddingLeft")||0,10)-parseInt(d.currentItem.css("paddingRight")||0,10))}}}}d.placeholder=$(e.placeholder.element.call(d.element,d.currentItem));d.currentItem.after(d.placeholder);e.placeholder.update(d,d.placeholder)},_contactContainers:function(c){var h,f,n,k,l,p,q,g,m,e,d=null,o=null;for(h=this.containers.length-1;h>=0;h--){if($.contains(this.currentItem[0],this.containers[h].element[0])){continue}if(this._intersectsWith(this.containers[h].containerCache)){if(d&&$.contains(this.containers[h].element[0],d.element[0])){continue}d=this.containers[h];o=h}else{if(this.containers[h].containerCache.over){this.containers[h]._trigger("out",c,this._uiHash(this));this.containers[h].containerCache.over=0}}}if(!d){return}if(this.containers.length===1){if(!this.containers[o].containerCache.over){this.containers[o]._trigger("over",c,this._uiHash(this));this.containers[o].containerCache.over=1}}else{n=10000;k=null;m=d.floating||this._isFloating(this.currentItem);l=m?"left":"top";p=m?"width":"height";e=m?"clientX":"clientY";for(f=this.items.length-1;f>=0;f--){if(!$.contains(this.containers[o].element[0],this.items[f].item[0])){continue}if(this.items[f].item[0]===this.currentItem[0]){continue}q=this.items[f].item.offset()[l];g=false;if(c[e]-q>this.items[f][p]/2){g=true}if(Math.abs(c[e]-q)<n){n=Math.abs(c[e]-q);k=this.items[f];this.direction=g?"up":"down"}}if(!k&&!this.options.dropOnEmpty){return}if(this.currentContainer===this.containers[o]){if(!this.currentContainer.containerCache.over){this.containers[o]._trigger("over",c,this._uiHash());this.currentContainer.containerCache.over=1}return}k?this._rearrange(c,k,null,true):this._rearrange(c,null,this.containers[o].element,true);this._trigger("change",c,this._uiHash());this.containers[o]._trigger("change",c,this._uiHash(this));this.currentContainer=this.containers[o];this.options.placeholder.update(this.currentContainer,this.placeholder);this.containers[o]._trigger("over",c,this._uiHash(this));this.containers[o].containerCache.over=1}},_createHelper:function(d){var e=this.options,c=$.isFunction(e.helper)?$(e.helper.apply(this.element[0],[d,this.currentItem])):(e.helper==="clone"?this.currentItem.clone():this.currentItem);if(!c.parents("body").length){$(e.appendTo!=="parent"?e.appendTo:this.currentItem[0].parentNode)[0].appendChild(c[0])}if(c[0]===this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}}if(!c[0].style.width||e.forceHelperSize){c.width(this.currentItem.width())}if(!c[0].style.height||e.forceHelperSize){c.height(this.currentItem.height())}return c},_adjustOffsetFromHelper:function(c){if(typeof c==="string"){c=c.split(" ")}if($.isArray(c)){c={left:+c[0],top:+c[1]||0}}if("left" in c){this.offset.click.left=c.left+this.margins.left}if("right" in c){this.offset.click.left=this.helperProportions.width-c.right+this.margins.left}if("top" in c){this.offset.click.top=c.top+this.margins.top}if("bottom" in c){this.offset.click.top=this.helperProportions.height-c.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var c=this.offsetParent.offset();if(this.cssPosition==="absolute"&&this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0])){c.left+=this.scrollParent.scrollLeft();c.top+=this.scrollParent.scrollTop()}if(this.offsetParent[0]===this.document[0].body||(this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()==="html"&&$.ui.ie)){c={top:0,left:0}}return{top:c.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:c.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition==="relative"){var c=this.currentItem.position();return{top:c.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:c.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:(parseInt(this.currentItem.css("marginLeft"),10)||0),top:(parseInt(this.currentItem.css("marginTop"),10)||0)}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var d,f,c,e=this.options;if(e.containment==="parent"){e.containment=this.helper[0].parentNode}if(e.containment==="document"||e.containment==="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e.containment==="document"?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,(e.containment==="document"?this.document.width():this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!(/^(document|window|parent)$/).test(e.containment)){d=$(e.containment)[0];f=$(e.containment).offset();c=($(d).css("overflow")!=="hidden");this.containment=[f.left+(parseInt($(d).css("borderLeftWidth"),10)||0)+(parseInt($(d).css("paddingLeft"),10)||0)-this.margins.left,f.top+(parseInt($(d).css("borderTopWidth"),10)||0)+(parseInt($(d).css("paddingTop"),10)||0)-this.margins.top,f.left+(c?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt($(d).css("borderLeftWidth"),10)||0)-(parseInt($(d).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,f.top+(c?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt($(d).css("borderTopWidth"),10)||0)-(parseInt($(d).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(f,h){if(!h){h=this.position}var e=f==="absolute"?1:-1,c=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=(/(html|body)/i).test(c[0].tagName);return{top:(h.top+this.offset.relative.top*e+this.offset.parent.top*e-((this.cssPosition==="fixed"?-this.scrollParent.scrollTop():(g?0:c.scrollTop()))*e)),left:(h.left+this.offset.relative.left*e+this.offset.parent.left*e-((this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():g?0:c.scrollLeft())*e))}},_generatePosition:function(f){var h,g,i=this.options,e=f.pageX,d=f.pageY,c=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==this.document[0]&&$.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,j=(/(html|body)/i).test(c[0].tagName);if(this.cssPosition==="relative"&&!(this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}if(this.originalPosition){if(this.containment){if(f.pageX-this.offset.click.left<this.containment[0]){e=this.containment[0]+this.offset.click.left}if(f.pageY-this.offset.click.top<this.containment[1]){d=this.containment[1]+this.offset.click.top}if(f.pageX-this.offset.click.left>this.containment[2]){e=this.containment[2]+this.offset.click.left}if(f.pageY-this.offset.click.top>this.containment[3]){d=this.containment[3]+this.offset.click.top}}if(i.grid){h=this.originalPageY+Math.round((d-this.originalPageY)/i.grid[1])*i.grid[1];d=this.containment?((h-this.offset.click.top>=this.containment[1]&&h-this.offset.click.top<=this.containment[3])?h:((h-this.offset.click.top>=this.containment[1])?h-i.grid[1]:h+i.grid[1])):h;g=this.originalPageX+Math.round((e-this.originalPageX)/i.grid[0])*i.grid[0];e=this.containment?((g-this.offset.click.left>=this.containment[0]&&g-this.offset.click.left<=this.containment[2])?g:((g-this.offset.click.left>=this.containment[0])?g-i.grid[0]:g+i.grid[0])):g}}return{top:(d-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+((this.cssPosition==="fixed"?-this.scrollParent.scrollTop():(j?0:c.scrollTop())))),left:(e-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+((this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():j?0:c.scrollLeft())))}},_rearrange:function(g,f,d,e){d?d[0].appendChild(this.placeholder[0]):f.item[0].parentNode.insertBefore(this.placeholder[0],(this.direction==="down"?f.item[0]:f.item[0].nextSibling));this.counter=this.counter?++this.counter:1;var c=this.counter;this._delay(function(){if(c===this.counter){this.refreshPositions(!e)}})},_clear:function(d,f){this.reverting=false;var c,g=[];if(!this._noFinalSort&&this.currentItem.parent().length){this.placeholder.before(this.currentItem)}this._noFinalSort=null;if(this.helper[0]===this.currentItem[0]){for(c in this._storedCSS){if(this._storedCSS[c]==="auto"||this._storedCSS[c]==="static"){this._storedCSS[c]=""}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}if(this.fromOutside&&!f){g.push(function(h){this._trigger("receive",h,this._uiHash(this.fromOutside))})}if((this.fromOutside||this.domPosition.prev!==this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!==this.currentItem.parent()[0])&&!f){g.push(function(h){this._trigger("update",h,this._uiHash())})}if(this!==this.currentContainer){if(!f){g.push(function(h){this._trigger("remove",h,this._uiHash())});g.push((function(h){return function(i){h._trigger("receive",i,this._uiHash(this))}}).call(this,this.currentContainer));g.push((function(h){return function(i){h._trigger("update",i,this._uiHash(this))}}).call(this,this.currentContainer))}}function e(j,h,i){return function(k){i._trigger(j,k,h._uiHash(h))}}for(c=this.containers.length-1;c>=0;c--){if(!f){g.push(e("deactivate",this,this.containers[c]))}if(this.containers[c].containerCache.over){g.push(e("out",this,this.containers[c]));this.containers[c].containerCache.over=0}}if(this.storedCursor){this.document.find("body").css("cursor",this.storedCursor);this.storedStylesheet.remove()}if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity)}if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex==="auto"?"":this._storedZIndex)}this.dragging=false;if(!f){this._trigger("beforeStop",d,this._uiHash())}this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(!this.cancelHelperRemoval){if(this.helper[0]!==this.currentItem[0]){this.helper.remove()}this.helper=null}if(!f){for(c=0;c<g.length;c++){g[c].call(this,d)}this._trigger("stop",d,this._uiHash())}this.fromOutside=false;return !this.cancelHelperRemoval},_trigger:function(){if($.Widget.prototype._trigger.apply(this,arguments)===false){this.cancel()}},_uiHash:function(c){var d=c||this;return{helper:d.helper,placeholder:d.placeholder||$([]),position:d.position,originalPosition:d.originalPosition,offset:d.positionAbs,item:d.currentItem,sender:c?c.element:null}}});return b});M.define("/js/module/app/Page",function(b,a,d){function c(e){M.mix(this,e);this.container=$(this.container);if(!this.container.length){this.container=$(document)}this.init();if(!M.isEmptyObject(this.events)){this.setEvents(this.events)}this.bindEvents()}M.mix(c.prototype,{container:null,events:[],init:$.noop,bindEvents:$.noop,setEvents:function(e){M.forEach(e,$.proxy(function(i,g){var j=g.split(","),h=$.trim(j[0]),f=j.slice(1);if(i in this.eventHandlers){if(f.length){f=$.trim(f.join(","));this.container.on(h,f,$.proxy(this.eventHandlers[i],this))}else{this.container.on(h,$.proxy(this.eventHandlers[i],this))}}},this))},destroy:$.noop,eventHandlers:{}});d.exports=c});M.define("/js/note/ControllerImagesReorder",function(f){f("jq-tmpl");f("jqui-selectable");f("jqui-sortable");var b=f("/js/module/app/Page"),l=f("dialog/Dialog"),j=f("dialog/alert"),d=f("ScrollBar");var n=$("#_j_sort_box"),m=n.find(".du_con"),i=m.children("ul"),k=$("#_j_content_box"),h=$("#_j_sortitem_texttip_tmpl"),c=$("#_j_sortitem_tmpl"),e=n.find("._j_sort_ok"),a=window.Env.id,g=$(window).height();return{events:{"click,._j_sort_ok":"saveSort","click,._j_side_trigger":"toggleSideBox","click,._j_sort_cancel":"cancelSort","click,.du_con li":"toggleSelectItem"},init:function(){this.sortBoxTip=null;this.contentData=window.Env.contentData;this.bindEvents();this.initSideSortBlock()},bindEvents:function(){i.on("mouseenter","li.word, li.li_paragraph",$.proxy(function(o){this.mouseEnterItem($(o.currentTarget))},this)).on("mouseleave","li.word, li.li_paragraph",$.proxy(function(o){this.mouseLeaveItem($(o.currentTarget))},this));M.Event.on("content data inserted",$.proxy(function(o){this.insertItems(o.beforeSeq,o.data)},this));M.Event.on("content data updated",$.proxy(function(o){this.updateItem(o.seq,o.data)},this));M.Event.on("content data deleted",$.proxy(function(o){this.deleteItem(o.seq)},this))},toggleSideBox:function(o){if(n.data("open")){this.closeSideSortBlock()}else{this.openSideSortBlock()}},saveSort:function(q){var r=$(q.currentTarget),p=this.getSortSeqList(),o=this.formalFocusSeq||0;if(!this.isSorting()){this.startSorting();$.post("/note/ajax.php",{id:a,act:"sideSort",seq_list:JSON.stringify(p)},$.proxy(function(s){this.stopSorting();if(s.data){M.Event.fire("sidesort:finished",{seq:o});if(s.data.content_data&&s.data.content_data.length){var t=[0,this.contentData.length].concat(s.data.content_data);Array.prototype.splice.apply(this.contentData,t)}this.closeSideSortBlock()}else{j.pop("服务器异常，请稍后再试")}},this),"json")}},cancelSort:function(o){this.stopSorting();this.refreshSortBox();this.closeSideSortBlock()},toggleSelectItem:function(o){$(o.currentTarget).toggleClass("ui-selected")},isSorting:function(){return e.hasClass("n_loading")},startSorting:function(){e.addClass("n_loading")},stopSorting:function(){e.removeClass("n_loading")},getSortSeqList:function(){var o=[];i.children("li").each(function(p,q){o.push($(q).data("seq"))});return o},mouseEnterItem:function(s){if(!this.sortBoxTip){this.sortBoxTip=h.tmpl({}).appendTo("body")}if(n.data("open")&&!n.is(":animated")){var o=m.outerWidth(),x=m.outerHeight(),u=s.position().top,q=s.position().left,r,y,t=s.children(".word_data").html(),p=this.sortBoxTip.children(".word_text"),w=this.sortBoxTip.children(".word_more"),v=p.children("p");v.html(t);if(v.height()>p.height()){w.show()}else{w.hide()}if((o-q)<530){r=s.offset().left+s.outerWidth()-530;this.sortBoxTip.addClass("wc_right")}else{r=s.offset().left;this.sortBoxTip.addClass("wc_left")}if((x-u)<(190+10+s.outerHeight())){y=s.offset().top-190-10;this.sortBoxTip.addClass("wc_up")}else{y=s.offset().top+s.outerHeight()+10;this.sortBoxTip.addClass("wc_down")}this.sortBoxTip.css({left:r,top:y}).show()}},mouseLeaveItem:function(o){this.sortBoxTip&&this.sortBoxTip.removeClass("wc_left wc_right wc_up wc_down").hide()},initSideSortBlock:function(){this.refreshSortBox();n.selectable({filter:"li",cancel:"input,textarea,button,select,option,a"});n.selectable("disable");i.sortable({items:"> li",cursor:"move",distance:15,delay:100,placeholder:"sort_holder",appendTo:"body",revert:true,helper:$.proxy(function(r,p){var q=$(p).siblings(".ui-selected").add($(p));this.recordSortingItem(q);q.addClass("sort_move").each(function(){$(this).data("index",$(this).index())});if($(p).hasClass("word")){return'<div class="sort_drag_word"></div>'}else{if($(p).hasClass("li_paragraph")){return'<div class="sort_drag_title"></div>'}else{if($(p).hasClass("li_video")){return'<div class="sort_drag_video"></div>'}else{if($(p).hasClass("li_image")){var o=$(p).find(".photo");if(!o.length){return'<div class="sort_drag"></div>'}return'<div class="sort_drag"><img src="'+o.attr("src")+'" /></div>'}else{return'<div class="sort_drag"></div>'}}}}},this),start:function(o,p){$(p.helper).css({width:76,height:76});$(p.item).addClass("ui-selected").data("one","one")},stop:$.proxy(function(o,p){this.itemTop=0;var q=$(p.item);this.preFocusSeq=0;$(p.item).removeClass("sort_move").removeClass("ui-selected").siblings(".sort_move").each(function(){var r=$(this).clone().removeClass("sort_move").removeClass("ui-selected");$(this).data("index")<$(p.item).data("index")?$(p.item).before(r):(q.after(r),q=q.next());$(this).remove()})},this),change:$.proxy(function(o,p){this.formalFocusSeq=this.preFocusSeq},this),sort:$.proxy(function(o,p){this.autoScrollSorts(p.offset.top)},this),});i.sortable("disable");this.sortBoxScrollBar=new d({container:m,wrap:m.parent(),barTPL:'<div class="scrollbar" style="height: auto; position:absolute;right:0;top:0;width:5px;height:100px;background-color:#d6d6d6;border-radius:10px;cursor:pointer"></div>'});$(window).on("resize",$.proxy(function(){g=$(window).height();if(n.data("open")){n.css("width",$(window).width()-100);m.css("height",$(window).height()-150);M.Event(this.sortBoxScrollBar).fire("contentchange")}},this))},autoScrollSorts:function(w){var p=this.itemTop||w,t=1.5,r=200,q=m.scrollTop(),v=m.height(),s=m.offset().top,o=p-w,u=o>0?"up":"down";if(g<650){r=100}else{if(g<800){r=150}}if(w-s<r){m.scrollTop(q-Math.abs(o)*t)}else{if(Math.abs(s+v-w)<r){m.scrollTop(q+Math.abs(o)*t)}}this.itemTop=w},recordSortingItem:function(o){this.preFocusSeq=o.length?o.last().data("seq"):0;this.formalFocusSeq=0},openSideSortBlock:function(){i.children("li").css("opacity",0);n.animate({width:$(window).width()-100},300,$.proxy(function(){n.addClass("drag_down").children(".drag_main").removeClass("drag_down_main");m.css("height",$(window).height()-150);n.selectable("enable");i.sortable("enable").children("li").css("opacity",1);M.Event(this.sortBoxScrollBar).fire("contentchange")},this)).data("open",true)},closeSideSortBlock:function(){i.children("li").css("opacity",0);n.children(".drag_main").addClass("drag_down_main");n.animate({width:0},300,function(){n.removeClass("drag_down");m.css("height","auto");n.selectable("disable");i.sortable("disable").children("li").css("opacity",1).removeClass("ui-selected")}).data("open",false)},insertItems:function(p,o){if(p>0){i.children('[data-seq="'+p+'"]').after(this.createSortItems(o))}else{i.prepend(this.createSortItems(o))}if(n.hasClass("hide")){n.removeClass("hide")}},updateItem:function(o,p){i.children('[data-seq="'+o+'"]').replaceWith(this.createSortItem(p))},deleteItem:function(o){i.children('[data-seq="'+o+'"]').remove()},createSortItems:function(o){var p=[];M.forEach(o,$.proxy(function(q){p.push(this.createSortItem(q))},this));return p.join("")},createSortItem:function(o){if(o.type=="txt"){if(o.content.length>100){o.content==o.content.slice(0,100)+"..."}o.content=o.content.replace(/\n/g,"<br>").replace(/[\s<>]/g,function(r,q){if(r==" "){return"&nbsp;"}else{if(r=="<"){return"&lt;"}else{if(r==">"){return"&gt;"}}}return""})}var p=c.tmpl({data:o});if(o.type=="txt"){p.children("li").children(".word_data").html(o.content)}return p.html()},refreshSortBox:function(){m.children("ul").html(this.createSortItems(this.contentData))}}});M.define("FrequencyAppVerify",function(e,c,f){var b=e("FrequencyVerifyControl");var d=0,g='<div class="popYzm _j_fre_verify_',a='"><div class="protectedYZM"><p>亲爱的蜂蜂，你发表速度有点像机器人<br>来证明下自己吧~</p><div class="YZMInput"><input class="_j_fre_text" type="text" placeHolder="验证码"></div><div class="YZMInput"><img src="http://images.mafengwo.net/images/home_new2015/verify.gif" width="150px" height="40px"><label><a href="javascript:void(0);" class="_j_change_img">看不清，换一张</a></label></div><div class="YZMSubmit"><a href="javascript:void(0);" class="_j_fre_confirm" title="确定">确定</a><span class="n-error">错误次数过多，请稍候尝试</span></div></div></div>';function h(i){this.target=i.target;this.content=i.content;this.app=i.app;this.left=i.left;this.top=i.top;this.successHandler=$.noop;M.mix(this,i);this.init()}h.prototype={init:function(){$("body").append(g+d+a);this.initData();this.initPostion();this._baseFrequency=new b({container:this.verifyCon,app:this.app,successHandler:$.proxy(function(){M.Event.fire("frequency:app:verify:success");this.verifyCon.remove();this.successHandler(this.target)},this)});d++},initData:function(){this.verifyCon=$("._j_fre_verify_"+d);this.verifyCon.find("p").html(this.content);this.verifyPo=this.verifyCon.find(".protectedYZM")},initPostion:function(){var o=this.target.offset().left;if(typeof this.top==="undefined"){var i=this.target.offset().top}else{var i=this.top;this.verifyCon.css("position","fixed")}var p=this.target.outerHeight();var l=this.target.outerWidth();this.verifyCon.css({left:o+"px",top:i+"px"});var j=$(document).width();var k=$(document).height();var q="l";if(o>j/2){q="r"}var n="t";if(i>k/2){n="b"}var m="";if(q=="l"&&n=="t"){if(i>200){m="atTop"}else{this.verifyCon.css({top:(i+p+5)+"px"})}}else{if(q=="r"&&n=="t"){if(i>200){m="atTopRight"}else{m="atRight"}this.verifyCon.css({left:(o+l)+"px"})}else{if(q=="r"&&n=="b"){m="atTopRight";this.verifyCon.css({left:(o+l)+"px"})}else{m="atTop"}}}if(m.length>0){this.verifyPo.addClass(m)}},show:function(){this.verifyCon.show();return this},hide:function(){this.verifyCon.hide();return this},refreshImg:function(){this._baseFrequency.refreshImg();return this},destroy:function(){this.verifyCon.undelegate();this.verifyCon.remove();this.verifyCon=null;M.Event(this).fire("afterdestroy")}};f.exports=h});M.define("HoldWithinScroll",function(b,a,c){var f=0;function e(){return"_js_hold_block_fixed_"+f++}function d(g){this.elem=null;this.reservePosTop=0;this.styleWhenFixed="";this.extraJudgeCondition=null;M.mix(this,g);this.elem=$(this.elem);this.window=$(window);this.holdCommonFixedClass="_js_hold_block_fixed";this.holdCurrentFixedClass=e();this.init()}M.mix(d.prototype,{init:function(){this._reservePosTop=this.getRealfixedPosTop();this.bindEvents();this.createStyleNode([{n:this.getFixedClassName(true),s:"position: fixed; "+this.styleWhenFixed}]);setTimeout(function(){$(window).trigger("scroll")},1)},bindEvents:function(){this.window.scroll($.proxy(function(){this.setPosMode()},this));var g=0;this.window.resize($.proxy(function(h){clearTimeout(g);g=setTimeout($.proxy(function(){this._reservePosTop=this.getRealfixedPosTop()},this),200)},this));M.Event(this).on("body height change",$.proxy(function(h){this.setPosMode()},this))},getFixedClassName:function(g){var h=g?".":"";h+=this.holdCommonFixedClass;h+=g?", .":" ";h+=this.holdCurrentFixedClass;return h},setPosMode:function(){var i=this.window.scrollTop();var h=this.status;var g=false;if(M.isFunction(this.extraJudgeCondition)&&this.extraJudgeCondition(i)){M.Event(this).fire("extra condition trigger",{status:"fire"});this.hasFiredExtraCondition=true}else{if(this.hasFiredExtraCondition){M.Event(this).fire("extra condition trigger",{status:"over"});this.hasFiredExtraCondition=false}}if(i>this._reservePosTop){this.elem.addClass(this.getFixedClassName());h="fixed"}else{this.elem.removeClass(this.getFixedClassName());h="static"}if(this.status!==h){this.status=h;M.Event(this).fire("when status change",{nextStatus:h})}},getRealfixedPosTop:function(){if(M.isFunction(this.reservePosTop)){return this.reservePosTop()}return this.reservePosTop},createStyleNode:function(g){var h="";M.forEach(g,function(j){var i="";if(j.n&&j.s){if(M.is(j.s,"string")){i=j.s}else{if(M.isArray(j.s)){M.forEach(j.s,function(k){i.push(k).push(";")});i=i.join("")}else{return true}}h+=j.n+"{"+i+"}"}});M.addStyle(h)}});c.exports=d});M.closure(function(d){d("jq-tmpl");var b=d("/js/module/app/Page"),f=d("dialog/alert"),e=d("FrequencyAppVerify"),g=d("HoldWithinScroll"),h=d("dialog/Dialog"),c=d("ClickToggle");var a=window.Env.id;var j=new b({container:$("body"),events:{"click,._j_btn_publish":"publish","click,._j_preview":"preview"},init:function(){window.Env.isPublished&&this.initPublishBtnPosition();this.detectLowBrowser()},bindEvents:function(){M.Event.on("poi data changed",$.proxy(function(){this.saveInfo("sPoiData",JSON.stringify(window.Env.poiData))},this));M.Event.on("publish yzm init",$.proxy(function(){var k=i(this.frequencyVerify.verifyCon,"_j_fre_verify_");k=k?"."+k:"";if(this.frequencyVerify&&k){this.clickToggler=new c({container:k,innerSelector:k})}},this));M.Event.on("note save info",$.proxy(function(k){this.saveInfo(k.key,k.value)},this));M.Event.on("can publish note",$.proxy(function(){var k=$("._j_btn_publish");if(!k.hasClass("n_loading")){k.addClass("n_loading");this.checkAndSaveTxt($.proxy(function(){this.publish(k)},this))}},this));M.Event.on("can preview note",$.proxy(function(){var k=$("._j_preview");if(!k.hasClass("n_loading")){k.addClass("n_loading");this.checkAndSaveTxt($.proxy(function(){document.location.href=k.data("href")},this))}},this))},eventHandlers:{publish:function(k){M.Event.fire("detect content valid",{handlerName:"发表游记",fireFunc:"can publish note",})},preview:function(k){M.Event.fire("detect content valid",{handlerName:"预览",fireFunc:"can preview note",});return false}},detectLowBrowser:function(){if(($.browser.msie&&parseInt($.browser.version)<9)||($.browser.chrome&&parseInt($.browser.version)<20)||($.browser.mozilla&&parseInt($.browser.version)<10)){if(!$("#_js_lowBrowserTips").length){$('<div id="_js_lowBrowserTips" style="background-color: #333;"><div style="width: 980px;height: 50px;line-height: 50px;text-align: center;margin: 0 auto;color: #FFDB26;font-size: 14px;">您的浏览器版本过低，可能会影响游记编写体验，推荐使用最新版chrome、firefox、safari or IE11及以上等浏览器</div></div>').insertBefore($("body").children().first())}}},initPublishBtnPosition:function(){this.holding=new g({elem:"._js_actionBtn",reservePosTop:function(){return $(window).height()/3},extraJudgeCondition:function(k){return $("body").height()-$(window).height()-k<70},styleWhenFixed:"bottom: 30px; left: 50%;",});this.holding.btn=$("._js_actionBtn");M.Event(this.holding).on("when status change",$.proxy(function(k){if(k.nextStatus==="fixed"){this.holding.btn.addClass("translucent")}else{this.holding.btn.removeClass("translucent")}},this));M.Event(this.holding).on("extra condition trigger",$.proxy(function(k){var l=k.status==="fire"?"static":"fixed";M.Event(this.holding).fire("when status change",{nextStatus:l})},this));M.Event.on("content chunk loaded",M.bind(function(){M.Event(this.holding).fire("body height change")},this))},checkAndSaveTxt:function(k){M.Event.fire("detect has saved draft",{callback:k})},publish:function(k){$.post("/note/ajax.php",{act:"publish",id:a,publish_from:"new"},$.proxy(function(l){if(l.error){if(l.error.code==12){if(this.frequencyVerify){this.frequencyVerify.refreshImg();this.frequencyVerify.show()}else{this.frequencyVerify=new e({target:k,app:0,content:"请输入验证码",successHandler:$.proxy(function(){this.publish(k);this.frequencyVerify.destroy()},this)});M.Event.fire("publish yzm init")}}else{f.pop(l.error.msg)}k.removeClass("n_loading")}else{if(l.data&&l.data.iid){window.Env.isPublished=1;if(Env.isGoodNote){f.pop("由于你的游记非常优秀，此刻正在很好的展示位上优先展示，目前处于定稿状态。所以你的本次修改操作需经过人工审阅，可能会延迟生效。望知晓！ ",function(){if(l.data.mdd_tags){this.showLinkMddPop(l.data.mdd_tags,l.data.iid,l.data.ex_info,function(){location.href="/i/"+l.data.iid+".html"})}else{location.href="/i/"+l.data.iid+".html"}})}else{if(l.data.mdd_tags){this.showLinkMddPop(l.data.mdd_tags,l.data.iid,l.data.ex_info,function(){location.href="/i/"+l.data.iid+".html"})}else{location.href="/i/"+l.data.iid+".html"}}}}},this),"json")},saveInfo:function(l,m){var k={};if(M.isObject(l)){k=l}else{k[l]=m}if(window.Env.is_tag>0){k.iTag=1}$.post("/note/ajax.php",{act:"saveInfo",id:a,info:JSON.stringify(k)})},showLinkMddPop:function(r,z,n,y){var u=new h({PANEL_CLASS:"popup-box pub-last",content:$("#_j_relate_mdd_pop_tmpl").tmpl({mdd_tags:r,ex_info:n}),stackable:false,newLayer:true}),k=u.getPanel(),v="";var t=k.find(".pl-search"),A=t.find("input.search-input"),s=t.find(".pl-schlist"),p=k.find(".input_mddname_panel"),q=k.find(".input_mddname"),o,w=-1,m="",x=null;k.on("click",'a[name="info_tag"]',function(B){A.val("");q.html("");p.hide();k.find('a[name="info_tag"]').each(function(){var C=$(this);C.removeClass("cur")});$(this).addClass("cur")}).on("click",".btn-done",function(B){k.find('a[name="info_tag"]').each(function(){var C=$(this);if(C.hasClass("cur")){v=C.html()}});if(!v){v=A.val();v=v.replace(/(^\s*)|(\s*$)/g,"")}if(!v){f.pop("请选择或填写关联目的地")}else{$.post("/group/infotag.php",{iid:z,tags:v},function(){u.close()})}}).on("focus",".search-input",function(B){k.find('a[name="info_tag"]').each(function(){var C=$(this);C.removeClass("cur")})});A.keyup(function(C){var D={sAct:"KMdd_StructWebAjax|SearchMdd",sName:encodeURIComponent($.trim($(this).val()))},B="/ajax/router.php?";if(C.keyCode=="27"){s.hide();return}if(C.keyCode=="40"||C.keyCode=="38"){return}if(m==D.sName&&s[0].style.display=="block"){return}clearTimeout(o);if(x){x.abort()}if(!D.sName){s.hide();return}o=setTimeout(function(){for(var E in D){B+=E+"="+D[E]+"&"}B=B.slice(0,B.length-1);x=$.ajax({type:"GET",url:B,dataType:"json",success:function(F){if(F.succ){if(F.data.mdd.length){m=D.sName;l(F.data);w=F.data.exact?0:-1;s.show()}else{s.hide()}}else{alert(F.error.msg)}}})},200)});s.hover(function(){s.show()},function(){setTimeout(function(){s.hide()},2000)}).delegate("li","click",function(B){A.val($(this).data("mddname"));q.html($(this).data("mddname"));p.show();s.hide()});function l(G){var C=G.mdd,D=[];for(var E=0,B=C.length,F="";E<B;E++){F=E==0&&G.exact?"active":"";var H=C[E].name.replace(/<[^>]+>/g,"");D[D.length]='<li data-mddname="'+H+'">'+H+(C[E].parent?('<span class="">'+C[E].parent+"</span>"):"")+"</li>"}s.find("ul").html(D.join(""))}M.Event(u).on("afterclose",y);M.Event(u).on("aftershow",function(){});u.show()}});if(Env.isGoodNote){f.pop("由于你的游记非常优秀，此刻正在很好的展示位上优先展示，目前处于定稿状态。所以你的本次修改操作需经过人工审阅，可能会延迟生效。望知晓！ ")}function i(n,o){var l=$(n).get(0).className;var k=new RegExp("\\b([^\\b]"+o+"[^\\b])\\b");var m=l.match(k);if(m.length&&m.length>1){return $.trim(m[1])}return""}});